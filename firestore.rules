rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // In a real app, you'd check a custom claim or a user document field.
      // For now, let's assume we check the user document (requires a get()).
      // Or simpler: just check if the user is signed in for basic protection, 
      // and rely on frontend for admin UI hiding.
      // Ideally: get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- USERS ---
    match /users/{userId} {
      // Anyone can read a user profile (needed for feed author info)
      allow read: if true;
      
      // Only the user can write their own profile
      allow write: if isSignedIn() && isOwner(userId);
    }

    // --- VIDEOS (Articles) ---
    match /videos/{videoId} {
      // Anyone can read videos
      allow read: if true;

      // Only signed-in users can create
      allow create: if isSignedIn();

      // Only author or admin can update/delete
      allow update, delete: if isSignedIn() && (resource.data.uid == request.auth.uid || isAdmin());
      
      // --- COMMENTS (Subcollection) ---
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        // Only author or admin can delete
        allow delete: if isSignedIn() && (resource.data.author.uid == request.auth.uid || isAdmin());
      }
    }

    // --- CHATS ---
    match /chats/{chatId} {
      // Only participants can read/write
      allow read, write: if isSignedIn() && request.auth.uid in resource.data.participants;
      
      // Allow creating if you are in the participants list
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
    }
    
    // --- MESSAGES (Subcollection of Chats) ---
    match /chats/{chatId}/messages/{messageId} {
       // We need to check the PARENT chat document to see if user is a participant.
       // This requires a get() on the parent chat.
       allow read, write: if isSignedIn() && 
         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
  }
}
